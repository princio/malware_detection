var express = require('express');
var router = express.Router();
var sqlite3 = require('sqlite3').verbose();
var sqlite = require('sqlite');

router.get('/', async function(req, res, next) {
  const db = await sqlite.open({
    filename: '/home/princio/Desktop/malware_detection/models/database.sqlite3',
    driver: sqlite3.Database
  });
  let reports = await db.all("SELECT * FROM reports");
  res.render('reports', {reports});
  db.close();
});

router.get('/:id', async function(req, res, next) {
  const db = await sqlite.open({
    filename: '/home/princio/Desktop/malware_detection/models/database.sqlite3',
    driver: sqlite3.Database
  });

  const reports = await db.all("SELECT * FROM reports AS r WHERE r.model_id=$id", { $id: Number.parseInt(req.params.id)})

  for(let i = 0; i < reports.length; ++i)
  {
    let metrics = await db.all("SELECT * FROM metrics AS m WHERE m.report_id=$id", { $id: reports[i].id});
    reports.metrics = metrics.map(metric => {
      let obj = {}
      obj[metric.name] = {
        "precision": metric.precision,
        "recall": metric.recall,
        "f1_score": metric.f1_score,
        "support": metric.support
      };
      return obj;
    });
    let class_accuracies = await db.all("SELECT * FROM class_accuracy AS c WHERE c.report_id=$id", { $id: reports[i].id});
    console.log(class_accuracies);
    reports.class_accuracy = {};
    for(const class_acc of class_accuracies)
    {
      reports.class_accuracy[class_acc.class_name] = class_acc.value;
    }
  }

  res.render('reports', {reports});
});

module.exports = router;
