<template>
  <div id="app">
    <div
      ref="toolbar"
      style="
        display: flex;
        flex-direction: row;
        width: 75%;
        margin: auto;
        space-between: fill;
        justify-content: space-around;
      "
    >
      <div
        style="
          display: flex;
          flex-direction: row;
          width: 100%;
          text-align: left;
          justify-content: space-around;
        "
      >
        <div style="display: flex; flex-direction: column; text-align: left">
          <h4>$size$</h4>
          <div v-for="size in sizes" :key="size">
            <input
              type="checkbox"
              :id="size"
              :value="size"
              v-model="checkedSizes"
            />
            <label :for="size">{{ size }} </label>
          </div>
        </div>
        <div style="display: flex; flex-direction: column; text-align: left">
          <h4>$vDGA$</h4>
          <div v-for="dga in dgas" :key="dga">
            <input
              type="checkbox"
              :id="dga"
              :value="dga"
              v-model="checkedDgas"
            />
            <label :for="dga">{{ dga }} </label>
          </div>
        </div>
        <div style="display: flex; flex-direction: column; text-align: left">
          <h4>$f$</h4>
          <div v-for="(fx, index) in fxs" :key="fx">
            <input type="checkbox" :id="fx" :value="fx" v-model="checkedFxs" />
            <label :for="fx">{{ fxs_name[index] }} </label>
          </div>
        </div>
        <div style="display: flex; flex-direction: column; text-align: left">
          <h4>$vDGA$</h4>
          <div>
            <input type="radio" id="dga_eq" :value="false" v-model="dga_gt" />
            <label for="dga_eq">$=$</label>
          </div>
          <div>
            <input type="radio" id="dga_gt" :value="true" v-model="dga_gt" />
            <label for="dga_gt">$\ge$</label>
          </div>
        </div>

        <div style="display: flex; flex-direction: column; text-align: left">
          <h4>$\bar{th}$</h4>
          <div>
            <input type="radio" id="th_measure_mean" :value="'mean'" v-model="th_measure" />
            <label for="th_measure_mean">$\bar{\mu}$: mean</label>
          </div>
          <div>
            <input type="radio" id="th_measure_max" :value="'max'" v-model="th_measure" />
            <label for="th_measure_max">$\bar{M}$: max</label>
          </div>
        </div>

        <div style="display: flex; flex-direction: column; text-align: left">
          <h4>$th$</h4>
          <table style="padding: 0">
            <tr>
              <td><label :for="llr_th">${{ th_measure_sym }}_{\lambda}\cdot$</label></td>
              <td>
                <input
                  type="range"
                  name="llr_th"
                  id="llr_th"
                  min="0"
                  max="15"
                  step="0.1"
                  v-model="llr_th"
                />
              </td>
              <td><input type="text" style="width:30px" v-model="llr_th"/></td>
            </tr>
            <tr>
              <td><label :for="ctr_th">${{ th_measure_sym }}_{gt}+$</label></td>
              <td>
                <input
                  type="range"
                  name="ctr_th"
                  id="ctr_th"
                  min="0"
                  max="80"
                  step="1"
                  v-model="ctr_th"
                />
              </td>
              <td><input type="text" style="width:30px" v-model="ctr_th"/></td>
            </tr>
            <tr>
              <td><label :for="nx_th">${{ th_measure_sym }}_{nx}+$</label></td>
              <td>
                <input
                  type="range"
                  name="nx_th"
                  id="nx_th"
                  min="0"
                  max="80"
                  step="1"
                  v-model="nx_th"
                />
              </td>
              <td><input type="text" style="width:30px" v-model="nx_th"/></td>
            </tr>
            <tr>
              <td><label :for="nx_th">$\bar{th}_{p}=$</label></td>
              <td>
                <input
                  type="range"
                  name="th_p"
                  id="th_p"
                  min="0"
                  max="1"
                  step="0.05"
                  v-model="th_p"
                />
              </td>
              <td><input type="text" style="width:30px" v-model="th_p"/></td>
            </tr>
          </table>
        </div>
      </div>
      <button v-on:click="loadFile()">Reload</button>
      <button v-on:click="render()">Render</button>
    </div>

    <div ref="legend">
      <h3>
        Legend:
        <button v-on:click="toggle_legend()">{{ legend_btn_label }}</button>
      </h3>
      <table v-show="legend_show" style="text-align: left; margin: auto">
        <thead>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </thead>
        <tbody>
          <tr>
            <td>$s$</td>
            <td>size</td>
            <td>Window size, it could be $100$, $500$, $2500$.</td>
          </tr>
          <tr>
            <td>$\bar{M}^s_f$</td>
            <td>threshold</td>
            <td>
              Maximum of not infected windows having size $s$ for the function
              $f$.
            </td>
          </tr>
          <tr>
            <td>$th_f$</td>
            <td>threshold refiner</td>
            <td>
              Coefficient which is multiplied to $\bar{M}^s_f$ to refine the
              inspection.
            </td>
          </tr>
          <tr>
            <td>$\lambda$</td>
            <td>function</td>
            <td>
              A window is infected if its $LLR$ (aka $\lambda$) is greater than
              $\bar{M}^s_{\lambda} \cdot th_{\lambda}$.
            </td>
          </tr>
          <tr>
            <td>$nx$</td>
            <td>function</td>
            <td>
              A window is infected if it counts of domains responses is greater
              than $\bar{M}^s_{gt} \cdot th_{nx}$.
            </td>
          </tr>
          <tr>
            <td>$gt_{0.9}$</td>
            <td>function</td>
            <td>
              A window is infected if it counts of domains having inference
              greater than 0.9 is greater than $\bar{M}^s_{gt_{0.9}}$.
            </td>
          </tr>
          <tr>
            <td>$n_p$</td>
            <td>value</td>
            <td>Number of pcaps processed. This value depends on $vDGA$.</td>
          </tr>
          <tr>
            <td>$n_p^d$</td>
            <td>value</td>
            <td>
              Number of pcaps processed having at least one window infected.
            </td>
          </tr>
          <tr>
            <td>$N_w$</td>
            <td>value</td>
            <td>
              It is a normalized value which indicates <i>when</i> the first
              infected window has been detected.<br />$0$ indicates the first
              window, $1$ the last one.
            </td>
          </tr>
          <tr>
            <td>$n_w$</td>
            <td>value</td>
            <td>The total number of windows for the considered pcaps.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div ref="bounds">
      <h3>
        Bounds:
        <button v-on:click="toggle_bounds()">{{ bounds_btn_label }}</button>
      </h3>
      <div
      v-show="bounds_show" 
      style="
        display: flex;
        flex-direction: row;
        width: 100%;
        justify-content: space-around;
      "
      v-html="compiledBounds"></div>
    </div>

    <div
      id="df_table"
      style="
        display: flex;
        flex-direction: row;
        width: 100%;
        justify-content: space-around;
      "
      ref="mathJaxEl"
      v-html="compiledHtml"
    ></div>
  </div>
</template>

<script>
import axios from "axios";

export default {
  name: "App",
  components: {},
  data: function () {
    return {
      input: "",
      bounds: "",
      fxs_name: ["$nx$", "$\\lambda$", "$gt_{0.9}$"],
      fxs: ["nx", "llr", "ctr"],
      sizes: [100, 500, 2500],
      dgas: [1, 2, 3],
      llr_ths: [0.2, 0.5, 1, 1.2, 1.5, 2, 2.5, 3],
      ctr_ths: [0.2, 0.5, 1, 1.2, 1.5, 2, 2.5, 3],
      nx_ths: [0.2, 0.5, 1, 1.2, 1.5, 2, 2.5, 3],
      checkedSizes: [100, 500, 2500],
      checkedDgas: [1, 2, 3],
      checkedFxs: ["llr", "nx", "ctr"],
      th_measure: 'mean',
      llr_th: 1,
      ctr_th: 1,
      nx_th: 1,
      th_p: 0.5,
      dga_gt: false,
      legend_show: false,
      bounds_show: false
    };
  },
  mounted() {
    this.loadFile();
    this.renderMathJax(this.$refs.toolbar);
  },
  computed: {
    compiledHtml: function () {
      return this.input;
    },
    compiledBounds: function () {
      return this.bounds;
    },
    legend_btn_label: function () {
      return this.legend_show ? "Hide" : "Show";
    },
    bounds_btn_label: function () {
      return this.bounds_show ? "Hide" : "Show";
    },
    th_measure_sym: function () {
      return {
        mean: '\\bar{\\mu}',
        max: '\\bar{M}'
      }[this.th_measure]
    }
  },
  methods: {
    toggle_legend() {
      this.legend_show = !this.legend_show;
    },
    toggle_bounds() {
      this.bounds_show = !this.bounds_show;
    },
    render() {
      this.renderMathJax([this.$refs.toolbar]);
      this.renderMathJax([this.$refs.mathJaxEl]);
      this.renderMathJax([this.$refs.legend]);
      this.renderMathJax([this.$refs.bounds]);
    },
    loadFile() {
      let msg = "";
      if (this.checkedSizes.length === 0) msg += "Select at least one size.\n";
      if (this.checkedDgas.length === 0) msg += "Select at least one vDGA.\n";
      if (this.checkedFxs.length === 0)
        msg += "Select at least one function.\n";
      if (msg.length > 0) {
        alert(msg);
        return;
      }
      axios
        .post(
          "http://127.0.0.1:3000/df/windowed/html",
          {
            size: this.checkedSizes,
            dga_gt: this.dga_gt,
            dga: this.checkedDgas,
            fxs: this.checkedFxs,
            th_measure: this.th_measure,
            cfs: {
              llr: this.llr_th,
              ctr: this.ctr_th,
              nx: this.nx_th,
              ratio: this.th_p
            },
          },
          // { headers: { "Content-Type": "application/x-www-form-urlencoded", }, }
        )
        .then((result) => {
          var body;
          if (result.data.body)
            body = JSON.parse(result.data.body);
          else
            body = result.data;
          this.input = Buffer.from(body.html, "base64").toString("ascii");
          this.bounds = Buffer.from(body.bounds, "base64").toString("ascii");
          
          this.$nextTick().then(() => {
            this.renderMathJax();
          });
        })
        .catch((error) => {
          console.log(error);
        });
    },
    renderMathJax(refs = [this.$refs.mathJaxEl]) {
      if (window.MathJax) {
        window.MathJax.config = {
          tex: {
            inlineMath: [
              ["$", "$"],
              ["\\(", "\\)"],
            ],
          },
          svg: {
            fontCache: "global",
          },
        };
        if (window.MathJax.typesetPromise)
          window.MathJax.typesetPromise(refs);
      }
    },
  },
};
</script>

<style>
table > tbody > tr > td {
  vertical-align: middle;
  text-align: center;
  padding: 0 10px;
}
table > tbody > tr > th {
  text-align: left;
  padding: 0 20px;
}
table, .dataframe {
  border: 0 !important;
  padding: 50px 0px 0 0;
}
body {
  margin: 0;
  background-color: rgb(53, 53, 53);
}
#app {
  font-family: Avenir, Helvetica, Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-align: center;
  color: white; /*#2c3e50;*/
  padding: 20px;
}
th,
td {
  vertical-align: top;
}
</style>