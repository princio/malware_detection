import psycopg2
import pandas as pd
from model import Model
from publicsuffixlist import PublicSuffixList

psl = PublicSuffixList()


models = [Model.load('domain')]

db = psycopg2.connect("host=localhost dbname=dns user=postgres password=postgres")
cur = db.cursor()

cur.execute(
    """SELECT id, dn FROM dn WHERE suffix is distinct from '-ukw-';"""
)
dns = cur.fetchall()

if len(dns) == 0:
    print('No row to update for nn.')
else:
    df = pd.DataFrame(dns, columns=['id', 'dn'])

    for model in models:
        model.load_model()
        
    for model in models:
        df[model.name] = model.predict_raw(df[model.name + '_x'])

    cur.executemany("""UPDATE dn SET whole=%s WHERE id = %s::integer;""", df[['any', 'id']].values)

    db.commit()
