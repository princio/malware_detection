<template>
  <div class="applies">
    <h1>Applies</h1>
    <div style="text-align: left">
      <ul>
        <li>
          change cms from being a Plot2 data fetched in Plot2 to be a props passed by a parent component (in that case Applies.vue).<br>
          In this case:
          </li>
          <ul>
            <li>Calculate BOUNDS on every change.</li>
            <li>Avoid multiple DGA definition when multiple APPLIES are selected
              (i.e. if multiple APPLIES are selected, then only one DGA is selected automatically</li>
            <li>Bring BOUNDS on Plot2 inside FIELDS.</li>
          </ul>
      </ul>
        
    </div>

    <table
      v-if="applies.length > 0"
      class="center"
      ref="applies_table">
      <thead>
        <tr >
          <th style='width: 60px;' v-for="(h, hindex) in columns" :key="`columns_${hindex}`">
            <div class="column">
              <span style="height: 40px;">
                {{ h }}
              </span>
              <div>
                <button class="btn" v-on:click="setHSort(hindex, false)">
                  <font-awesome-icon :icon="['fas', 'sort-numeric-up-alt']" />
                  </button>
                <button class="btn" v-on:click="setHSort(hindex, true)">
                  <font-awesome-icon :icon="['fas', 'sort-numeric-down']" />
                </button>
              </div>
            </div>
          </th>
          <th>

          </th>
        </tr>
      </thead>
      <tbody ref="applies_table_body">
        <tr v-for="(apply, rindex) of applies" :key="`row_${rindex}`">
          <!-- <td>
            <router-link :to="{ name: 'ApplyRoute', params: { apply_id: row[0] }}">Applies</router-link>
          </td> -->
          <td v-for="(c, cindex) in columns" :key="`cell_index_${rindex}_${cindex}`">
            <router-link 
              v-if="c === 'name'"
              :to="{ name: 'ApplyRoute', params: { apply_id: apply.id }}"
              >
              {{ apply[c] }}
            </router-link>
            <span v-else>
              {{ apply[c] }}
            </span>
          </td>
          <td><button v-if="apply.check">show</button></td>
        </tr>
      </tbody>
    </table>
    <div class="center">
      <apply-bar v-on:update:fields="updateBarFields" :applies="applies" :mounted="mounted"></apply-bar>
      <apply-plot-dgas v-if="applies.length > 0" :show_infos="true" :applies="applies" :fields.sync="fields" :dfs="dfs"></apply-plot-dgas>
    </div>
  </div>
</template>

<script>
import ApplyBar from '../components/apply/Bar.vue';
// import ApplyPlot from '../components/apply/Plot.vue';
import ApplyPlot2 from '../components/apply/Plot2.vue';
const axios = require('axios');
const dfd = require("danfojs/dist/index");

export default {
  name: 'Applies',
  components: {
    'apply-bar': ApplyBar,
    'apply-plot-dgas': ApplyPlot2
  },
  data: function () {
    this.ths_measures = {};
    this.columns = [ 'name', 'wsize', 'windowing', 'wtype', 'nn_id', 'top10m', 'pinf', 'ninf', 'max', 'min', '' ]
    return {
      applies: [],
      cms: [],
      dfs: {},
      fields: {
        applies: {},
        bounds: { min: -100, max: 100 },
        dgas: {},
        sampling: 100,
        th: 50,
      },
      mounted: false,
      values: [],
    };
  },
  async mounted() {
    await this.fetch_applies();
    await this.fetch_dfs();
    this.mounted = true;
  },
  methods: {
    async fetch_applies() {
      const applies = (await axios.get("http://127.0.0.1:3000/mwdb/applies")).data.applies;

      this.applies = applies;
    },
    async fetch_dfs() {

      const df_applies = (
        await axios.post("http://127.0.0.1:3000/mwdb/apply/all", {
          rounder: this.fields.sampling,
        })
      ).data;

      this.dfs = Object.fromEntries(
        Object.keys(df_applies).map(apply_id => [ Number(apply_id), new dfd.DataFrame(df_applies[apply_id].values, { columns: df_applies[apply_id].columns }) ])
      );
    },
    updateBarFields (fields) {
      this.fields = fields;
    },
  },
  watch: {
    "fields.sampling": {
      async handler() {
        await this.fetch_dfs();
      },
      deep: true
    },  
  }
}
</script>


<style scoped>
.boldd {
  font-weight: bold;
  font-size: 16px;
}
.center {
  text-align: center;
  margin: auto;
}
#app > div.applies > table > tbody {
  text-align: left;
}
table > tbody > tr > td,th {
  text-align: left;
}
</style>