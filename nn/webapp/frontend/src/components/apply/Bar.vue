
<template>
  <div id="apply-bar">
    <table class="center">
      <tbody>
        <tr>
          <td>
            threshold:
            <div class="row">
              <input
                type="range"
                :min="bounds.min"
                :max="bounds.max"
                step=1
                v-on:change="emit_fields"
                v-model.number="fields.th"
              />
              <input type="text" style="width:50px"
                v-on:change="emit_fields"
                v-model.number="fields.th"
              />
            </div>
          </td>
          <td>
            campionamento:
            <div class="row">
              <input
                type="range"
                :min="10"
                :max="500"
                :step="10"
                v-on:change="emit_fields"
                v-model.number="fields.sampling"
              />
              <input type="text" style="width:50px"
                v-on:change="emit_fields"
                v-model.number="fields.sampling"
              />
            </div>
          </td>
          <td>
            <div class="column">
              Applies<br/>
              
              <button v-for="apply of applies" :key="`btn_apply_${apply.id}`"
                :class="{ active: fields.applies[apply.id] }"
                v-on:click="change_key('applies', apply.id)" >
                {{ apply.id }}_{{ apply.name }}
              </button>
            </div>
          </td>
          <td>
            <div class="column">
              DGAS
              
              <button v-for="dga in [ 1,2,3, 'all' ]" :key="`btn_dga_${dga}`"
                :class="{ active: fields.dgas[dga] }"
                v-on:click="change_key('dgas', dga)" >
                {{ dga }}
              </button>
            </div>
          </td>
          <td>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</template>

<script>
export default {
  name: "ApplyBar",
  props: [ 'applies', 'mounted' ],
  data: function(){
    this.bounds = { min: -100, max: 100 };
    return {
      dgas: { 1: false, 2: false, 3: false, 'all': true },
      fields: {
        applies: {},
        dgas: { 1: false, 2: false, 3: false, 'all': true },
        sampling: 100,
        th: 50,
      },
    }
  },
  async mounted() {
    this.fields.dgas['all'] = true;
  },
  methods: {
    set_bounds() {
      let max = 0;
      let min = 0;

      for (const apply of this.applies) {
        if (this.fields.applies[apply.id]) {
          if (max < apply.max) max = apply.max;
          if (min > apply.min) min = apply.min;
        }
      }

      this.bounds.max = 100000;
      this.bounds.min = -100000;
    },
    change_key(key, id) {
      // this.fields[key][id] = !this.fields[key][id];

      const n_dgas = Object.values(this.fields.dgas).reduce((pv, cv) => pv + cv);
      const n_applies = Object.values(this.fields.applies).reduce((pv, cv) => pv + cv);
      
      // if (((n_dgas === 0 || n_applies === 0) || (n_dgas > 1 && n_applies > 1))) {
      //   this.fields[key][id] = !this.fields[key][id];
      // }

      const n = key === 'dgas' ? n_dgas : n_applies;
      const n_other = key === 'dgas' ? n_applies : n_dgas;
      
      console.log(this.fields[key]);

      if (n === 1 && n_other > 1) {
        // const keys = Object.keys(this.fields[key]);
        // const pidx = keys.indexOf(String(id));
        // console.log(keys, id, pidx);
        // if (pidx >= 0 && this.fields.dgas[keys[pidx]]) { 
        //   this.fields.dgas[keys[pidx]] = false;
        // }
        for (const k in this.fields[key]) {
           this.fields[key][k] = false;
        }
      }

      this.fields[key][id] = !this.fields[key][id];

      if (key === "applies")
        this.set_bounds();

      this.emit_fields();
    },
    emit_fields() {
      this.$emit('update:fields', this.fields)
    }
  },
  watch: {
    'applies': {
      handler(applies) {
        let first = true;
        for (const apply of applies) {
          this.$set(this.fields.applies, apply.id, first)
          first = false;
          this.bounds[apply.id] = {
            max: applies.max,
            min: applies.min
          };
        }
        this.emit_fields();
      }
    },
    'mounted': {
      handler() {
        this.emit_fields();
      }
    }
  }
};
</script>

<style .scoped>
.active {
  background-color: lightskyblue;
}
</style>