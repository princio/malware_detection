
<template>
  <div id="apply-bar">
    <table class="center">
      <tbody>
        <tr>
          <td>
            threshold:
            <div class="row">
              <input
                type="range"
                :min="fields.bounds.min"
                :max="fields.bounds.max"
                step=1
                v-on:change="emit_fields"
                v-model.number="fields.th"
              />
              <input type="text" style="width:50px"
                v-on:change="emit_fields"
                v-model.number="fields.th"
              />
            </div>
          </td>
          <td>
            campionamento:
            <div class="row">
              <input
                type="range"
                :min="5"
                :max="100"
                :step="5"
                v-on:change="emit_fields"
                v-model.number="fields.sampling"
              />
              <input type="text" style="width:50px"
                v-on:change="emit_fields"
                v-model.number="fields.sampling"
              />
            </div>
          </td>
          <td>
            <div class="column">
              Applies<br/>
              
              <button v-for="apply in applies" :key="`btn_apply_${apply.id}`"
                :class="{ active: applies[apply.id].selected  }"
                v-on:click="change_apply(apply.id)" >
                {{ apply.name }}
              </button>
            </div>
          </td>
          <td>
            <div class="column">
              DGAS
              
              <button v-for="dga in [ 1,2,3, 'all' ]" :key="`btn_dga_${dga}`"
                :class="{ active: dgas[dga] }"
                v-on:click="change_dga(dga)" >
                {{ dga }}
              </button>
            </div>
          </td>
          <td>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</template>

<script>
const axios = require("axios");

export default {
  name: "ApplyBar",
  model: {
    prop: 'fields',
    event: 'change'
  },
  props: {
    fields: {
      type: Object,
      default: function () {
        return {
          th: 50,
          sampling: 100,
          dgas: [],
          applies: [],
          min: -100,
          max: 100,
          bounds: { min: -100, max: 100 }
        }
      }
    },
  },
  data: function(){
    return {
      applies: {},
      dgas: { 1: false, 2: false, 3: false, 'all': true }
    };
  },
  async mounted() {
    const applies = (await axios.get("http://127.0.0.1:3000/mwdb/applies")).data.applies;

    this.applies = Object.fromEntries(applies.map((a, i) => { a.selected = i == 0; return [ a.id, a ]; }));

    this.fields.applies = [ applies[0].id ];
    this.fields.dgas = [ 'all' ];
  },
  methods: {
    change_dga(dga) {
      const idx = this.fields.dgas.indexOf(dga);

      if (idx === -1) {
        this.fields.dgas.push(dga);
      } else 
      if (this.fields.dgas.length > 1) {
        this.fields.dgas.splice(idx, 1);
      } else {
        return;
      }

      this.dgas[dga] = !this.dgas[dga];
      this.emit_fields();
    },
    change_apply(apply_id) {
      const idx = this.fields.applies.indexOf(apply_id);

      if (idx === -1) {
        this.fields.applies.push(apply_id);
      } else 
      if (this.fields.applies.length > 1) {
        this.fields.applies.splice(idx, 1);
      } else {
        return;
      }

      this.applies[apply_id].selected = !this.applies[apply_id].selected;
      this.emit_fields();
    },
    emit_fields() {
      this.$emit('update:fields', this.fields)
    }
  },
};
</script>

<style .scoped>
.active {
  background-color: lightskyblue;
}
</style>