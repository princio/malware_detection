from flask import Flask, request, send_from_directory
from flask_cors import CORS, cross_origin
import os
import json
import psycopg2
import pandas as pd

app = Flask(__name__)
CORS(app)
DIR_CSV = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'csv')

db = psycopg2.connect("host=localhost dbname=dns user=postgres password=postgres")


@app.route('/csv/<string:filename>')
@cross_origin()
def send_json(filename):
    return send_from_directory(DIR_CSV, filename, as_attachment=False)


@app.route('/mwdb/apply')
@cross_origin()
def get_applies():

    df = pd.read_sql("""SELECT * FROM applies""", db)

    return {
        'header': df.columns.values.tolist(),
        'values': df.values.tolist() #.to_json(orient='values')
    }
    # return send_from_directory(DIR_CSV, 'applies.csv', as_attachment=False)

@app.route('/mwdb/pcap')
@cross_origin()
def get_pcaps():

    df = pd.read_sql("""SELECT * FROM pcap""", db)

    df = df.drop(columns='hash')

    return {
        'header': df.columns.values.tolist(),
        'values': df.values.tolist() #.to_json(orient='values')
    }

@app.route('/mwdb/pcap/json')
@cross_origin()
def get_pcaps_json():

    df = pd.read_sql("""SELECT * FROM pcap""", db)

    return df.to_json(orient='records')

@app.route('/mwdb/window/grouped/<apply_id>')
@cross_origin()
def get_window_grouped(apply_id, rounder=10):

    df = pd.read_sql(f"""
SELECT COUNT(*) AS WNUM,
	COUNT(DISTINCT PCAP_ID),
	MW.DGA,
	WVALUE
FROM
	(SELECT APPLY_ID,
			PCAP_ID,
			WCOUNT,
			ROUND(WVALUE::float / {rounder}) * {rounder} AS WVALUE
		FROM WINDOWS) AS W
JOIN PCAP AS P ON W.PCAP_ID = P.ID
JOIN MALWARE AS MW ON MW.ID = P.MALWARE_ID
WHERE APPLY_ID = {apply_id}
GROUP BY WVALUE,
	DGA;""", db)

    return df.to_json(orient='records')

if __name__ == "__main__":
    app.run(port=3000, debug=True)