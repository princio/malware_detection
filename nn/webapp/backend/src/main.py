from flask import Flask, request, send_from_directory
from flask_cors import CORS, cross_origin
import os
import json
import psycopg2
import pandas as pd

app = Flask(__name__)
CORS(app)
DIR_CSV = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'csv')

db = psycopg2.connect("host=localhost dbname=dns user=postgres password=postgres")


@app.route('/csv/<string:filename>')
@cross_origin()
def send_json(filename):
    return send_from_directory(DIR_CSV, filename, as_attachment=False)


@app.route('/mwdb/apply')
@cross_origin()
def applies():
    filepath = os.path.join(DIR_CSV, 'applies.csv')
    
    df = pd.read_sql("""SELECT * FROM applies""", db)

    return {
        'header': df.columns.values.tolist(),
        'values': df.values.tolist() #.to_json(orient='values')
    }
    # return send_from_directory(DIR_CSV, 'applies.csv', as_attachment=False)

if __name__ == "__main__":
    app.run(port=3000, debug=True)