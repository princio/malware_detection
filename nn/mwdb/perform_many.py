import math
from pathlib import Path
from apply_2 import perform
import utils
import psycopg2
from sqlalchemy import create_engine
import pandas as pd
import numpy as np
import json


eng = create_engine("postgresql://postgres:postgres@localhost/dns",)
db = psycopg2.connect("host=localhost dbname=dns user=postgres password=postgres")


### FOR DOCUMENTATION:
models = utils.get_models(db)
print('\n'.join([ f'###   {id}={models[id]["name"]}' for id in models ]))

with db.cursor() as cur:
    cur.execute("SELECT max(top10m) FROM public.dn2;")
    top10mmax = cur.fetchone()
print('top10m', top10mmax[0])


with db.cursor() as cur:
    cur.execute("SELECT min(logit) FROM public.dn_nn where logit != '-Infinity'")
    ninf = cur.fetchone()
print('NINF', ninf[0])


with db.cursor() as cur:
    cur.execute("SELECT max(logit) FROM public.dn_nn where logit != 'Infinity'")
    pinf = cur.fetchone()
print('PINF', pinf[0])

###
### MODELS:
###   1=nosfx
###   2=domain
###   3=any
###   4=domain_sfx
###   7=ICANN_1
###   8=NONE_1
###   9=PRIVATE_1
###   10=TLD_1
###
### WTYPE:
###   LLR, NX
###
### WINDOWING:
###   RES, REQ, BOTH
###
### TOP10M:
###   [0, 9999645]
###
### WSIZE:
### 100, 500, 2500
###
### PINF, NINF:
###   PINF > NINF
###   

def get_thrange(min, max, nth):
    nth = 100
    th_max = int(math.ceil(min))
    th_min = int(math.ceil(max))
    thrange = th_max - th_min
    th_step = int(thrange / nth)
    return [ th for th in range(th_min, th_max, th_step) ]


if __name__ == '__main__':

    models = [ 7, 8, 9, 10 ]

    wtypes = [ 'llr' ]

    top10ms = [ (0, 0), (1000, -50), (100_000, -50), (1_000_000, -50), (1_000_000, -10) ]

    wsizes = [ 100, 500, 2500 ]

    windowings = [ 'req', 'res', 'both' ]

    infs = [ ( -20, 20 ), ( -80, 20 ), ( -80, 80 ), ( -200, 200 ) ]

    outdir = Path('./perform_many/')

    configs = {}
    configs_json = {}
    for model_id in models:
        for wtype in wtypes:
            for top10m in top10ms:
                for wsize in wsizes:
                    for windowing in windowings:
                        for inf in infs:
                            config = utils.ApplyConfiguration(
                                '',
                                model_id,
                                wtype,
                                top10m,
                                wsize,
                                windowing,
                                inf
                            )
                            configs[config.__hash__()] = config
                            configs_json[config.__hash__()] = config.__dict__
                            configs_json[config.__hash__()]['performed'] = False
                            pass
    
    if not outdir.joinpath('configs.json').exists():
        with open(outdir.joinpath('configs.json'), 'w') as fp:
            json.dump(configs_json, fp)

        pass

    with open(outdir.joinpath('configs.json'), 'r') as fp:
        configs_json = json.load(fp)

    i = 0
    n = len(list(configs_json.keys()))
    outdir = Path('./perform_many/').joinpath('csvs')
    if not outdir.exists():
        outdir.mkdir()
    for hash in configs:
        i += 1
        config = configs[hash]
        if configs_json[hash]['performed'] is False:
            df = perform(config)
            df.to_csv(outdir.joinpath(config.__hash__()).with_suffix('.csv'), index=False)
            configs_json[hash]['performed'] = True
            with open(outdir.parent.joinpath('configs.json'), 'w') as fp:
                json.dump(configs_json, fp)
            print(f'{i}/{n}\t{hash}', end='done.\n')
            pass
        pass



    for hash in configs:
        df = pd.read_csv(outdir.joinpath(hash).with_suffix('.csv'), index_col=None)

        nth = 100

        thrange = np.linspace(df.wvalue.min(), df.wvalue.max(), num=nth, dtype=np.float32)

        p = sum(df.dga > 0)
        n = sum(df.dga == 0)
        values = []
        for th in thrange:
            tp = sum((df.wvalue >  th) & (df.dga > 0))
            tn = sum((df.wvalue <= th) & (df.dga == 0))
            fp = n - tn
            fn = p - tp

            values.append([ th, (tn, fp, fn, tn), tn/n, tp/p])
            pass

        df_th = pd.DataFrame(values, columns=[ 'th', 'cm', 'tn', 'tp' ])


        th2 = 0.7

        print(df_th[(df_th.tn > th2) & (df_th.tp > th2)])

        n_above = sum((df_th.tn > th2) & (df_th.tp > th2))

        print(f'{n_above}/{df_th.shape[0]}')
        pass