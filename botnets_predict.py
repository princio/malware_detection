from Model import Model
import pandas as pd
from DomainLevel import Transformer
import os, math

LIST_ROOT_DIR='/media/princio/ssd512/dns.list/'
YCSV_ROOT_DIR='/media/princio/ssd512/y.csv/'

models = [ Model.load(-3), Model.load(1), Model.load(4)]

files = []
DNs_lists = []
DNs = []
for walker in os.walk(LIST_ROOT_DIR):
    for filename in walker[2]:
        try:
            DNs.append(filename[:-9])
        except pd.errors.EmptyDataError:
            files.append({'name': filename[:-9], 'total': 0, 'uniques': 0})


def model_predict(model, name, dns, tr = None):
    if tr is None:
        tr = model.tr
    X = [tr.translator()(dn) for dn in dns]
    pd.DataFrame({'DN': dns, 'X': X}).to_csv(f'/tmp/{name}.{model.name}.{tr.name}.csv')
    y, _, _ = model.predict(X)
    return pd.Series(y)
   
df_Ys = {}
for num, name in enumerate(DNs):
    if num < 72:
        continue
    try:
        df_name = pd.read_csv(os.path.join(LIST_ROOT_DIR, f'{name}.dns.list'), names=['DN'])
        print('%5d/%d %s' % (num, len(DNs), name))

        series_DN = df_name['DN']
        
        df_y = pd.DataFrame(index=series_DN)
        for model in models:
            df_y[model.name] = model_predict(model, name, series_DN.values).to_frame().set_index(series_DN)
        
        print('done.\n')
        df_y.to_csv(f'/media/princio/ssd512/y.csv/{name}.y.csv')
        df_Ys[name] = df_y
    except:
        print('error with {name}')
