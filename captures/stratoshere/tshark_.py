import json
import subprocess
import pandas as pd


js = json.load(open('./tshark_dns.json','r'))

fields = {}
for j in js:
    if j[0].find('dns.svcb.') >= 0 or j[0].find('dns.dso') >= 0:
        continue
    if '3.4.2' not in j[3]:
        continue
    field = j[0].replace('dns.', '')
    tag = field[:field.find('.')]
    if tag not in fields:
        fields[tag] = []
    fields[tag].append(j[0])


opts = ['-e', 'ip.src', '-e', 'frame.number', '-e', 'frame.time_epoch', '-e', '_ws.col.Protocol']
fields_list = ['ip.src', 'frame.number', 'frame.time_epoch', '_ws.col.Protocol']
for tag in fields:
    for field in fields[tag]:
        opts.append('-e')
        opts.append(field)
        fields_list.append(field)

num = 10
command = ['tshark', '-r', '2013-11-06_capture-win6_head.pcap', '-Y', 'dns', '-c', str(num),
            '-T', 'fields'] + opts + ['-E', 'separator=,']

cmd = subprocess.run(command, capture_output=True, text=True)

outs = [a.split(',') for a in cmd.stdout.split('\n')]
outs.pop(-1)

values = {}
for k, out in enumerate(outs):
    for i, f in enumerate(fields_list):
        if out[i] != '':
            if f not in values:
                values[f] = [None]*num
            values[f][k] = out[i]

# pd.DataFrame(values).to_csv('/tmp/tshark_%s.csv' % tag)
print(pd.DataFrame(values).to_markdown())