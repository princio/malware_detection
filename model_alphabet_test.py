import psycopg2
import os, json
from Model import Model
from Metrics import Metrics
from Repository import DatasetRepository, ModelRepository

connection = psycopg2.connect(user = "postgres",
                                  password = "porcodio",
                                  host = "127.0.0.1",
                                  port = "5432",
                                  database = "malware")

def model_accuracy():
    model = ModelRepository.fetch(connection, 'fb9ffddd-de28-439c-8ae5-3473f390e6cf') #'c62c1bed-722f-4a7e-b0a8-09d2b50e9732')

    datasets = DatasetRepository.fetchmany_bypath(connection, ('datasets/malware_h_t/25_2014-02-07_capture-win3.pcap_table.csv__h_t.csv', 
                                                        'datasets/malware_h_t/35_2014-01-31_capture-win7.pcap_table.csv__h_t.csv'))

    with open(f'output/model_{model.hash}_test.txt', 'w') as fp:
        for dataset in datasets:
            fp.write(f'{dataset.path}\n')
            model.load_model()
            confusion_matrix_, _time_elapsed = model.test(dataset)
            metrics = Metrics.create(labels=dataset.labels, confusion_matrix=confusion_matrix_, dga=dataset.dga)
            fp.write(f'{metrics.__str__()}\n')
            fp.write('\n\n')

if __name__ == "__main__":

    model_accuracy()

    pass