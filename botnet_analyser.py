import pandas as pd
from Extractor import Extractor
import os, math

LIST_ROOT_DIR='/media/princio/ssd512/dns.list/'
YCSV_ROOT_DIR='/media/princio/ssd512/y.csv/'
YREQ_ROOT_DIR='/media/princio/ssd512/req.y.csv/'


ycsv_list = []
for walker in os.walk(YREQ_ROOT_DIR):
    for filename in walker[2]:
        try:
            ycsv_list.append(filename)
        except pd.errors.EmptyDataError:
            print(f'File <{filename}> is empty.')

if False:

    unique_sum = 0
    unique_domain_sum = 0
    dict_total = {}
    dict_domain_sfx_total = {}
    for n, df_id in enumerate(ycsv_list):
        if n < 14: continue
        print(f'{n+1}/{len(ycsv_list)}: {df_id}')
        try:
            df = pd.read_csv(os.path.join(YREQ_ROOT_DIR, df_id), index_col=0).drop(columns=['domain'])
        except:
            continue
            
        if df.shape[0] < 100: continue

        df_or = df.copy()    
        df_counts = df['DN'].value_counts().to_frame().rename(index={'index': 'DN'}, columns={'DN': 'count'})
        df = df.drop_duplicates().join(df_counts, on=['DN'])
        df = df.sort_values(by=['count'], ascending=False)
        # df.to_csv(f'/media/princio/ssd512/unique.req.y.csv/{df_id}')

        dict_ = df.set_index('DN')[['count']].to_dict(orient='index')

        series_dn = df['DN'].apply(Extractor.DOMAIN_SFX.translator())
        series_count = df['count']

        dff = pd.DataFrame({'DN': series_dn, 'count': series_count})

        dff = dff.groupby(by='DN').sum()

        dff = dff.reset_index().set_index('DN')['count']
        dict_domain_sfx = dff.to_dict()

        print(df_or.shape[0], dff.sum())

        tot_0 = 0
        tot_1 = 0
        domain_sfx_already = []
        for idx in dict_:
            domain_sfx = Extractor.domain_sfx(idx)
            num_0 = dict_[idx]['count']


            if not idx in dict_total:
                dict_total[idx] = 0
            dict_total[idx] += num_0

            if not domain_sfx in domain_sfx_already:
                domain_sfx_already.append(domain_sfx)
                num_1 = dict_domain_sfx[domain_sfx]
                if not domain_sfx in dict_domain_sfx_total:
                    dict_domain_sfx_total[domain_sfx] = 0
                dict_domain_sfx_total[domain_sfx] += num_1
                tot_1 += num_1

            tot_0 += num_0

        if tot_0 != tot_1:
            print('Diversi!:\t\t%10d != %10d' % (tot_0, tot_1))


    df1 = pd.DataFrame(dict_total.values(), index=dict_total.keys())
    df2 = pd.DataFrame(dict_domain_sfx_total.values(), index=dict_domain_sfx_total.keys())

    df1.to_csv('/media/princio/ssd512/unique.csv')
    df2.to_csv('/media/princio/ssd512/unique.domain_sfx.csv')


    df_top = pd.read_csv('/media/princio/ssd512/top-1m.csv')



df2 = pd.read_csv('/media/princio/ssd512/unique.domain_sfx.csv')
df_top_1m = pd.read_csv('/media/princio/ssd512/top-1m.csv')
bibo = df_top_1m.set_index('DN').join(df2.set_index('DN'), lsuffix='stocazzo')
print(bibo.dropna())


df_top_10m = pd.read_csv('/media/princio/ssd512/top-10mln.csv')
bibo = df_top_10m.set_index('DN').join(df2.set_index('DN'), lsuffix='stocazzo')
print(bibo[bibo['count']])


