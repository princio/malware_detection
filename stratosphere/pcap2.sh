#!/bin/bash

dns_s=()
csv_s=()
list_s=()
for pcap_path in $(ls /media/princio/ssd512/pcap/*.pcap);
do
       pcap=$(basename "$pcap_path")
	wo_ext="${pcap:0:${#pcap}-5}"
	
       echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
	echo "$pcap:"

       if [ ! -e "/media/princio/ssd512/dns/$wo_ext.pcap.dns" ]; then
              echo "> added to dns-filtering tail"
              dns_s+=($wo_ext)
       fi
       if [ ! -e "/media/princio/ssd512/csv/$wo_ext.dns.csv" ]; then
              echo "> added to csv-generating tail"
              csv_s+=($wo_ext)
       fi
       if [ ! -e "/media/princio/ssd512/list/$wo_ext.dns.list" ]; then
              echo "> added to csv-listing tail"
              list_s+=($wo_ext)
       fi
done

echo "Would you continue? [Y/n]"
read -p "Are you sure? " -n 1 -r
if [[ ! $REPLY =~ ^[Yy]$ ]]
then
    echo "Aborted..."
    exit 0
fi

for dns in ${dns_s[@]}; do
       in_path="/media/princio/ssd512/dns/$dns.pcap"
       out_path="/media/princio/ssd512/dns/$dns.pcap.dns"
       echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
       echo "DNS filtering  <$dns>..."
       tshark -r "$in_path"\
              -Y 'dns && !_ws.malformed && !icmp' \
              -w "$out_path.progress"
       if [ $? = 0 ]; then
              mv "$out_path.progress" "$out_path"
       else
              mv "$out_path.progress" "$out_path.error_$?"
       fi
done

for csv in ${csv_s[@]}; do
       in_path="/media/princio/ssd512/csv/$csv.pcap.dns"
       out_path="/media/princio/ssd512/csv/$csv.dns.csv"
       echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
       echo "CSV generating  <$csv>..."
       tshark -r "$in_path" \
              -Y 'dns && !_ws.malformed && !icmp'              \
              -T fields -e frame.number -e frame.time_epoch    \
              -e ip.src -e ip.dst -e dns.qry.name              \
              -e dns.flags.response -e dns.qry.type -e dns.a   \
              -E separator=, \
              > "$out_path.progress"
       if [ $? = 0 ]; then
              mv "$out_path.progress" "$out_path"
       else
              mv "$out_path.progress" "$out_path.error_$?"
       fi
done

for list in ${list_s[@]}; do
       in_path="/media/princio/ssd512/list/$list.dns.csv"
       out_path="/media/princio/ssd512/list/$list.dns.list"
       echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
       echo "Awking  <files/$list.csv>:"
       awk -F "\"*,\"*" '{print $5}' "$in_path" > "$out_path.progress"
       if [ $? = 0 ]; then
              mv "$out_path.progress" "$out_path"
       else
              mv "$out_path.progress" "$out_path.error_$?"
       fi
done

exit 0
