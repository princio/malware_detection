#!/bin/bash


for pcap_path in $(ls /media/princio/ssd512/*.pcap)
do
       pcap=$(basename "$pcap_path")
	wo_ext="${pcap:0:${#pcap}-5}"

	echo "Converting $pcap ($wo_ext)..."
       
       if [ -e "files/$wo_ext.csv" ]
       then
              echo "No conversion needed, file already exists."
       else
              tshark -r "$pcap_path" -Y 'dns && !_ws.malformed && !icmp' \
                     -T fields -e frame.number -e frame.time_epoch    \
                     -e ip.src -e ip.dst -e dns.qry.name              \
                     -e dns.flags.response -e dns.qry.type -e dns.a   \
                     -E separator=, > "files/$wo_ext".csv
       fi

       if [ ! -e "files/$wo_ext.dns" ]
       then
	       echo "Generating <.dns> file..."
              awk -F "\"*,\"*" '{print $5}' "files/$wo_ext.csv" > "files/$wo_ext.dns"
       fi
done

exit 0
