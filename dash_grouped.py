
import dash
import dash_core_components as dcc
import dash_html_components as html
import dash_table
from dash.dependencies import Input, Output
from plotly.subplots import make_subplots
import sqlite3
import pandas as pd
import plotly.express as px
import numpy as np
import plotly.graph_objects as go


db_path = '/media/princio/ssd512/stratosphere/db_3.sqlite3'
dirs = {
    'malware': '/media/princio/ssd512/stratosphere/pcap/csv/malware/',
    'normal': '/media/princio/ssd512/stratosphere/pcap/csv/normal/'
}

db = sqlite3.connect(db_path)
df_pcaps = pd.read_sql('SELECT * from pcap', db)
db.close()
df_pcaps = df_pcaps.drop(columns=['s_id', 's_win'])
df_pcaps.set_index('id', inplace=True, drop=False)

app = dash.Dash(__name__)

app.layout = html.Div([
        html.Div([
            dash_table.DataTable(
                id='left-datatable-row-ids',
                columns=[
                    {'name': i, 'id': i, 'deletable': True} for i in df_pcaps.columns if i != 'id'
                ],
                data=df_pcaps.to_dict('records'),
                editable=True,
                filter_action="native",
                sort_action="native",
                sort_mode='multi',
                row_selectable='multi',
                row_deletable=True,
                selected_rows=[],
                page_action='none',
                style_table={'height': '300px', 'overflowY': 'auto', 'overflowX': 'auto'}
            ),
            html.Div(id='left-datatable-row-ids-container')
        ],
        style={'width': '50%'}),
        html.Div([
            dash_table.DataTable(
                id='right-datatable-row-ids',
                columns=[
                    {'name': i, 'id': i, 'deletable': True} for i in df_pcaps.columns if i != 'id'
                ],
                data=df_pcaps.to_dict('records'),
                editable=True,
                filter_action="native",
                sort_action="native",
                sort_mode='multi',
                row_selectable='multi',
                row_deletable=True,
                selected_rows=[],
                page_action='none',
                style_table={'height': '300px', 'overflowY': 'auto', 'overflowX': 'auto'}
            ),
            html.Div(id='right-datatable-row-ids-container')
        ],
        style={'width': '50%'})
    ],
    style={'display': 'flex', 'flex-direction': 'row'}
)

template='seaborn'
color_scale='rainbow'

def update_graphs_logic(active_cell):
    if active_cell is None: return []
    active_row_id = active_cell['row_id']
    db = sqlite3.connect(db_path)
    df = pd.read_sql('select * from pcap_queries_2 WHERE pcap_id = %d' % active_row_id, db)
    db.close()

    df['count2'] = df['response-ok'].add(df['no-such-name'])
    count = 'count'
    df_tot = df[count].sum()

    df['responsivity'] = df['response-ok']/df[count]
    df['responsivity_w'] = df['response-ok'] * (df[count].div(df_tot))
    df['response-no'] = df[count] - df['response-ok']
    df['responsivity_w'] = df['response-ok'].sub(df['response-no']).div(df[count]) #/ df_tot #* (df[count].div(df_tot))


    df['legitness'] = df[['responsivity_w', 'legit_list']].apply(lambda x: 1 if x[1] == 1 else x[0], axis=1)

    print(df[['legitness', 'responsivity_w', 'legit_list']])

    df['count_rest'] = df[count].apply(np.log10).round(2)
    df['count_log10'] = df[count].apply(np.log10).round(0)
    df["top10m"] = df["legit_list"].apply(lambda x: 'legit' if x == 1 else 'unknown')


    figures = [
        px.scatter(df,
        template=template,
        x='legitness',
        y="nosfx", 
        color='top10m', opacity=0.8,
        size='count_rest',
        symbol='count_log10', 
        hover_data=['query', 'response-ok', count, 'no-response', 'no-such-name', 'intervals_mean', 'intervals_std'])
    ]

    for figure in figures:
        figure.update_layout(
            #coloraxis_colorbar=dict(len=100, lenmode='pixels'),
            yaxis=dict(
                range=[-0.1, 1.1],
                dtick=0.2,
                tick0=0,
                nticks=5
            )
        )

    df_conf = dict(
        true_malware = df[(df['nosfx'] > 0.5) & (df['legitness'] < 0)].shape[0],
        false_malware = df[(df['nosfx'] > 0.5) & (df['legitness'] > 0)].shape[0],
        false_legit = df[(df['nosfx'] < 0.5) & (df['legitness'] < 0)].shape[0],
        true_legit = df[(df['nosfx'] < 0.5) & (df['legitness'] > 0)].shape[0]
    )
    colors = ['red', 'blue', 'black', 'white']
    fig = go.Figure(data=[go.Pie(labels=list(df_conf.keys()), values=list(df_conf.values()))])
    fig.update_traces(marker=dict(colors=colors, line=dict(color='#000000', width=2)))
    figures.append(fig)

    df_conf = dict(
        response_ok = df['response-ok'].sum(),
        no_such_name = df['no-such-name'].sum(),
        no_response = df['no-response'].sum(),
        response_other_error = df['response-error'].sum()-df['no-such-name'].sum(),
    )
    colors = ['red', 'blue', 'black', 'white']
    fig = go.Figure(data=[go.Pie(labels=list(df_conf.keys()), values=list(df_conf.values()))])
    fig.update_traces(marker=dict(colors=colors, line=dict(color='#000000', width=2)))
    figures.append(fig)

    return [ dcc.Graph(figure=figure) for figure in figures ]

@app.callback(
    Output('left-datatable-row-ids-container', 'children'),
    Input('left-datatable-row-ids', 'active_cell'))
def update_graphs(*args, **kwargs):
    return update_graphs_logic(*args, **kwargs)

@app.callback(
    Output('right-datatable-row-ids-container', 'children'),
    Input('right-datatable-row-ids', 'active_cell'))
def update_graphs(*args, **kwargs):
    return update_graphs_logic(*args, **kwargs)

if __name__ == '__main__':
    app.run_server(debug=False)
